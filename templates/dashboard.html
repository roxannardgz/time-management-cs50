{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<div class="container py-4">

    <!-- Row 1: Timer / current activity -->
    <section class="mb-4">
        <div class="card">
            <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
                <div>
                    <h2 class="h3 mb-1">Welcome back, {{ user_name }}!</h2>

                    <p class="mb-0">
                        {% if active_session %}
                        <span class="d-inline-flex align-items-center gap-2 px-3 py-1 rounded-pill
                     status-pill status-pill--active small">
                            <b>◉ Now tracking:</b>
                            {{ active_session["category"] }}
                            · {{ active_session["subcategory"] }}
                            · <span class="text-muted">
                                started at {{ active_session["start_ts"] | format_time }}
                            </span>
                        </span>
                        {% else %}
                        <span class="d-inline-flex align-items-center px-3 py-1 rounded-pill
                     status-pill status-pill--inactive small">
                            ◯ No active session
                        </span>
                        {% endif %}
                    </p>


                </div>



                {% if not active_session %}
                <div class="dashboard-tracker">
                    <form method="post" action="/sessions/start" class="row g-2 align-items-end">

                        <!-- Category Dropdown -->
                        <div class="col-12 col-md-4">
                            <label for="categorySelect" class="form-label mb-1">Category</label>
                            <select id="categorySelect" name="category" class="form-select w-100" required>
                                <option value="" selected disabled>Choose category</option>
                                {% for category, subcats in activities_by_cat.items() %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Subcategory Dropdown -->
                        <div class="col-12 col-md-4">
                            <label for="subcategorySelect" class="form-label mb-1">Subcategory</label>
                            <select id="subcategorySelect" name="subcategory" class="form-select w-100" required>
                                <option value="" selected disabled>Choose subcategory</option>
                            </select>
                        </div>

                        <!-- Button - Start -->
                        <div class="col-12 col-md-4">
                            <button type="submit" class="btn btn-secondary tracker-btn w-100">
                                Start session
                            </button>
                        </div>

                    </form>
                </div>

                {% else %}
                <div class="dashboard-tracker">
                    <form method="post" action="/sessions/stop">
                        <button type="submit" class="btn btn-outline-danger tracker-btn w-100">
                            Stop session
                        </button>
                    </form>
                </div>
                {% endif %}

            </div>
        </div>
    </section>


    <!-- Row 2: Dashboard Section -->
    <section class="mb-4">
        <div class="card">
            <div class="card-body p-4">

                <!-- Dashboard header: view and category selector -->
                <div class="d-flex align-items-center justify-content-end mb-3">

                    <form method="get" class="d-flex align-items-center gap-2">
                        <label for="periodSelect" class="form-label mb-0 small text-muted">View</label>
                        <select id="periodSelect" name="period" class="form-select form-select-sm"
                            onchange="this.form.submit()">
                            <option value="today" {% if period=="today" %}selected{% endif %}>Today</option>
                            <option value="week" {% if period=="week" %}selected{% endif %}>Last 7 days</option>
                        </select>

                        <label for="dashboardCategorySelect"
                            class="form-label mb-0 small text-muted ms-2">Category</label>
                        <select id="dashboardCategorySelect" name="category" class="form-select form-select-sm w-auto"
                            onchange="this.form.submit()">
                            {% for category in categories_available %}
                            <option value="{{ category }}" {% if category==selected_category %}selected{% endif %}>{{
                                category }}</option>
                            {% endfor %}
                        </select>
                    </form>

                </div>



                <!-- Main grid -->
                <div class="row g-3 align-items-stretch">

                    <!-- TOP – METRICS -->
                    <div class="col-12 mb-3">
                        <div class="row g-3 align-items-stretch">

                            <!-- 1) Time tracked (big) -->
                            <div class="col-12 col-lg-4">
                                <div class="card h-100">
                                    <div class="card-body kpi-big-card kpi-big-compact">

                                        <div class="kpi-big-top">
                                            <div class="kpi-icon kpi-icon--md">
                                                <i class="bi bi-clock"></i>
                                            </div>
                                            <div class="kpi-big-title text-uppercase">Time tracked</div>
                                        </div>

                                        <div class="kpi-big-value">{{ kpis.total_time_tracked_hhmm }}</div>

                                        <div class="kpi-big-bottom">
                                            <div class="progress kpi-progress kpi-progress--thin">
                                                <div class="progress-bar" role="progressbar"
                                                    style="width: {{ kpis.tracked_pct_period }}%;"
                                                    aria-valuenow="{{ kpis.tracked_pct_period }}" aria-valuemin="0"
                                                    aria-valuemax="100"></div>
                                            </div>
                                            <div class="small text-muted">{{ kpis.period_label }}</div>
                                        </div>

                                    </div>
                                </div>
                            </div>


                            <!-- 2) Most time spent (big) -->
                            <div class="col-12 col-lg-4">
                                <div class="card h-100">
                                    <div class="card-body kpi-big-card kpi-big-compact">

                                        <div class="kpi-big-top">
                                            <div class="kpi-icon kpi-icon--md">
                                                <i class="bi bi-star"></i>
                                            </div>
                                            <div class="kpi-big-title text-uppercase">Most time spent</div>
                                        </div>

                                        <div class="kpi-big-value">{{ kpis.top_category }}</div>

                                        <div class="kpi-big-bottom">
                                            <div class="progress kpi-progress kpi-progress--thin">
                                                <div class="progress-bar" role="progressbar"
                                                    style="width: {{ kpis.top_category_pct_of_tracked }}%;"
                                                    aria-valuenow="{{ kpis.top_category_pct_of_tracked }}"
                                                    aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <div class="small text-muted">{{ kpis.top_category_time_hhmm }}</div>
                                        </div>

                                    </div>
                                </div>
                            </div>


                            <!-- 3) Small cards section -->
                            <div class="col-12 col-lg-4">
                                <div class="row g-3 h-100">

                                    <!-- Activities cnt -->
                                    <div class="col-6">
                                        <div class="card h-100 kpi-mini-card">
                                            <div class="card-body kpi-small-card kpi-mini-body">
                                                <div class="kpi-small-value">{{ kpis.activities_count }}</div>
                                                <div class="kpi-icon kpi-icon--sm">
                                                    <i class="bi bi-list-check"></i>
                                                </div>
                                                <div class="kpi-small-title text-uppercase">Activities</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Categories cnt -->
                                    <div class="col-6">
                                        <div class="card h-100 kpi-mini-card">
                                            <div class="card-body kpi-small-card kpi-mini-body">
                                                <div class="kpi-small-value">{{ kpis.categories_count }}</div>
                                                <div class="kpi-icon kpi-icon--sm">
                                                    <i class="bi bi-grid"></i>
                                                </div>
                                                <div class="kpi-small-title text-uppercase">Categories</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Time tracked (percent) -->
                                    <div class="col-12">
                                        <div class="card h-100 kpi-mini-card">
                                            <div class="card-body kpi-small-card kpi-mini-body">
                                                <div class="kpi-small-value">{{ kpis.tracked_pct_period | int }}%
                                                </div>
                                                <div class="kpi-icon kpi-icon--sm">
                                                    <i class="bi bi-percent"></i>
                                                </div>
                                                <div class="kpi-small-title text-uppercase">Percent of total Time
                                                    Tracked</div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div>
                    </div>



                    <!-- LEFT -->
                    <div class="col-12 col-lg-8 d-flex">
                        <div class="card w-100 h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-info-circle chart-help text-muted" data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Shows how your tracked time is distributed across categories for the selected period. The highlighted bar is the selected category.">
                                        </i>
                                        <h3 class="h6 mb-0">Hours by category</h3>

                                    </div>
                                    <span class="badge bg-light text-muted">{% if period =="today" %}Today{% else %}Last
                                        7 days{% endif %}</span>
                                </div>
                                {% if chart_divs %}
                                {{ chart_divs.div_today_by_category | safe }}
                                {% else %}
                                <p>No data today.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT -->
                    <div class="col-12 col-lg-4 d-flex">
                        <div class="w-100 d-flex flex-column gap-3">

                            <!-- Card 1: Donut -->
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-info-circle chart-help text-muted" data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Shows how much of your total tracked time belongs to the selected category compared to everything else.">
                                            </i>
                                            <h3 class="h6 mb-0">Category Share</h3>
                                        </div>
                                        <span class="badge bg-light text-muted">{{ selected_category }}</span>
                                    </div>
                                    {% if chart_divs %}
                                    {{ chart_divs.div_category_share | safe }}
                                    {% else %}
                                    <p class="mb-0">No data.</p>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Card 2: Subcategory breakdown -->
                            <div class="card flex-grow-1">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-info-circle chart-help text-muted" data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Shows the breakdown of time spent within the selected category, by subcategory.">
                                            </i>
                                            <h3 class="h6 mb-0">Subcategory Breakdown</h3>
                                        </div>
                                        <span class="badge bg-light text-muted">{{ selected_category }}</span>

                                    </div>
                                    {% if chart_divs %}
                                    {{ chart_divs.div_subcategory_breakdown | safe }}
                                    {% else %}
                                    <p class="mb-0">No data.</p>
                                    {% endif %}
                                </div>
                            </div>

                        </div>
                    </div>

                    {% if period == "week" %} <!-- Bottom card only for week view -->
                    <div class="col-12">
                        <div class="card mt-3">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-info-circle chart-help text-muted" data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            title="Daily time trend over the last 7 days. The highlighted line shows the selected category; other categories are shown for context.">
                                        </i>
                                        <h3 class="h6 mb-0">Trend - Last 7 days</h3>
                                    </div>
                                    <span class="badge bg-light text-muted">{{ selected_category }}</span>
                                </div>
                                {{ chart_divs.div_weekly_trend | safe }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div> <!-- /card-body -->
        </div> <!-- /card -->
    </section>



    <a href="{{ url_for('index') }}">Back</a>

    <!-- Generated using ChatGPT -->
    <script>
        // Save scroll position before reload/navigation
        window.addEventListener("beforeunload", () => {
            sessionStorage.setItem("scrollY", window.scrollY);
        });

        document.addEventListener("DOMContentLoaded", function () {
            // Restore scroll position after reload
            const y = sessionStorage.getItem("scrollY");
            if (y !== null) window.scrollTo(0, parseInt(y, 10));

            // Dropdown logic
            const activitiesByCat = {{ activities_by_cat | tojson
        }};
        const categorySelect = document.getElementById("categorySelect");
        const subcategorySelect = document.getElementById("subcategorySelect");

        if (!categorySelect || !subcategorySelect) return;

        function populateSubcats(cat) {
            const subcats = activitiesByCat[cat] || [];
            subcategorySelect.innerHTML =
                '<option value="" selected disabled>Choose subcategory</option>';

            subcats.forEach(sub => {
                const opt = document.createElement("option");
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        }

        categorySelect.addEventListener("change", function () {
            populateSubcats(this.value);
        });
    });
    </script>

    {% endblock %}




    <!-- Dashboard desing inspiration -->
    <!-- 
    https://dribbble.com/shots/22951308-Coffee-Shop-Dashboard-Management
    https://dribbble.com/shots/26192889-Novelty-Modern-Dashboard-UI-for-Cafe-Management
    https://dribbble.com/shots/24784122-Coffee-Shop-Dashboard
    -->