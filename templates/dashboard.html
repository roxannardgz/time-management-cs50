{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<div class="container py-4">

    <!-- Row 1: Timer / current activity -->
    <section class="mb-4">
        <div class="card">
            <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
                <div>
                    <h2 class="h4 mb-1">Now tracking</h2>
                    <p class="text-muted mb-0">
                        {% if active_session %}
                        {{ active_session["category"] }} · {{ active_session["subcategory"] }} · started at {{
                        active_session["start_ts"] }}
                        {% else %}
                        No active session
                        {% endif %}
                    </p>
                </div>

                {% if not active_session %}
                <div class="dashboard-tracker">
                    <form method="post" action="/sessions/start" class="row g-2 align-items-end">

                        <!-- Category Dropdown -->
                        <div class="col-12 col-md-4">
                            <label for="categorySelect" class="form-label mb-1">Category</label>
                            <select id="categorySelect" name="category" class="form-select w-100" required>
                                <option value="" selected disabled>Choose category</option>
                                {% for category, subcats in activities_by_cat.items() %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Subcategory Dropdown -->
                        <div class="col-12 col-md-4">
                            <label for="subcategorySelect" class="form-label mb-1">Subcategory</label>
                            <select id="subcategorySelect" name="subcategory" class="form-select w-100" required>
                                <option value="" selected disabled>Choose subcategory</option>
                            </select>
                        </div>

                        <!-- Button - Start -->
                        <div class="col-12 col-md-4">
                            <button type="submit" class="btn btn-secondary tracker-btn w-100">
                                Start session
                            </button>
                        </div>

                    </form>
                </div>

                {% else %}
                <div class="dashboard-tracker">
                    <form method="post" action="/sessions/stop">
                        <button type="submit" class="btn btn-outline-danger tracker-btn w-100">
                            Stop session
                        </button>
                    </form>
                </div>
                {% endif %}

            </div>
        </div>
    </section>


    <!-- Row 2: Dashboard Section -->
    <section class="mb-4">
        <div class="card">
            <div class="card-body p-4">

                <!-- Dashboard header -->
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h2 class="h4 mb-0">Dashboard</h2>

                    <form method="get" class="d-flex align-items-center gap-2">
                        <label for="periodSelect" class="form-label mb-0 small text-muted">View</label>
                        <select id="periodSelect" name="period" class="form-select form-select-sm"
                            onchange="this.form.submit()">
                            <option value="today" {% if period=="today" %}selected{% endif %}>Today</option>
                            <option value="week" {% if period=="week" %}selected{% endif %}>Last 7 days</option>
                        </select>
                    </form>
                </div>

                <!-- Main grid -->
                <div class="row g-3 align-items-stretch">

                    <!-- TOP – METRICS -->
                    <div class="col-12">
                        <div class="row my-3">
                            <div class="col-12">
                                <div class="card flex-fill">
                                    <div class="card-body">
                                        <div class="row mb-3 g-3">
                                            <div class="col-12 col-md-4">
                                                <div class="card">
                                                    <div class="card-body kpis">
                                                        <div class="kpi-label">Time tracked today</div>
                                                        <div class="kpi-label">{{ kpis.total_time_tracked }}</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-12 col-md-4">
                                                <div class="card">
                                                    <div class="card-body kpis">
                                                        <div class="kpi-label">Most time spent on</div>
                                                        <div class="kpi-label">{{ kpis.top_category }}</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-12 col-md-4">
                                                <div class="card">
                                                    <div class="card-body">Placeholder</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- LEFT -->
                    <div class="col-12 col-lg-8 d-flex">
                        <div class="card w-100 h-100">
                            <div class="card-body">
                                {% if chart_divs %}
                                {{ chart_divs.div_today_by_category | safe }}
                                {% else %}
                                <p>No data today.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT -->
                    <div class="col-12 col-lg-4 d-flex">
                        <div class="card w-100 h-100">
                            <div class="card-body d-flex flex-column">

                                <!-- Header + dropdown -->
                                <div class="d-flex align-items-center justify-content-between mb-3">
                                    <form method="get" class="d-flex align-items-center gap-2">
                                        <input type="hidden" name="period" value="{{ period }}">

                                        <label for="dashboardCategorySelect" class="form-label mb-0 small text-muted">
                                            Category
                                        </label>

                                        <select id="dashboardCategorySelect" name="category"
                                            class="form-select form-select-sm w-auto" onchange="this.form.submit()">
                                            {% for category in categories_available %}
                                            <option value="{{ category }}" {% if category==selected_category
                                                %}selected{% endif %}>
                                                {{ category }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </form>
                                </div>

                                {% if chart_divs %}

                                <!-- Donut / category share -->
                                <div class="mb-3">
                                    {{ chart_divs.div_category_share | safe }}
                                </div>

                                <!-- Subcategory breakdown -->
                                <div class="flex-grow-1">
                                    {{ chart_divs.div_subcategory_breakdown | safe }}
                                </div>

                                {% else %}
                                <p>No data today.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if period == "week" %} <!-- Bottom card only for week view -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <h3 class="h6">Trend</h3>
                            {{ chart_divs.trend | safe }}
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div> <!-- /card-body -->
        </div> <!-- /card -->
    </section>



    <a href="{{ url_for('index') }}">Back</a>

    <!-- Generated using ChatGPT -->
    <script>
        // Save scroll position before reload/navigation
        window.addEventListener("beforeunload", () => {
            sessionStorage.setItem("scrollY", window.scrollY);
        });

        document.addEventListener("DOMContentLoaded", function () {
            // Restore scroll position after reload
            const y = sessionStorage.getItem("scrollY");
            if (y !== null) window.scrollTo(0, parseInt(y, 10));

            // Dropdown logic
            const activitiesByCat = {{ activities_by_cat | tojson
        }};
        const categorySelect = document.getElementById("categorySelect");
        const subcategorySelect = document.getElementById("subcategorySelect");

        if (!categorySelect || !subcategorySelect) return;

        function populateSubcats(cat) {
            const subcats = activitiesByCat[cat] || [];
            subcategorySelect.innerHTML =
                '<option value="" selected disabled>Choose subcategory</option>';

            subcats.forEach(sub => {
                const opt = document.createElement("option");
                opt.value = sub;
                opt.textContent = sub;
                subcategorySelect.appendChild(opt);
            });
        }

        categorySelect.addEventListener("change", function () {
            populateSubcats(this.value);
        });
    });
    </script>

    {% endblock %}




    <!-- Dashboard desing inspiration -->
    <!-- 
    https://dribbble.com/shots/22951308-Coffee-Shop-Dashboard-Management
    https://dribbble.com/shots/26192889-Novelty-Modern-Dashboard-UI-for-Cafe-Management
    https://dribbble.com/shots/24784122-Coffee-Shop-Dashboard
    -->